name: Deploy to Lightsail

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Deploy to server
      uses: appleboy/ssh-action@v0.1.5
      env:
        ADMIN_USERNAME: ${{ secrets.ADMIN_USERNAME }}
        ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        envs: ADMIN_USERNAME,ADMIN_PASSWORD
        script: |
          echo "🚀 Starting bulletproof deployment..."
          
          # Backup current app.py
          cp /home/ubuntu/cfb-app/app.py /home/ubuntu/app.py.backup
          echo "✅ Backup created"
          
          # Update git and test new version
          cd /home/ubuntu/cfb-app-git
          git pull origin main
          echo "✅ Git updated"
          
          # Test new app.py can import without errors
          cd /home/ubuntu/cfb-app-git
          if python -c "from app import app; print('✅ Import test passed')" 2>/dev/null; then
              echo "✅ New code validated"
              
              # Copy new version
              cp /home/ubuntu/cfb-app-git/app.py /home/ubuntu/cfb-app/
              
              # Regenerate templates
              cd /home/ubuntu/cfb-app
              source venv/bin/activate
              mkdir -p templates
              rm -f templates/*
              python -c "from app import create_templates; create_templates()"
              
              # Update environment variables if needed
              if ! grep -q "ADMIN_USERNAME" /etc/systemd/system/cfb-rankings.service; then
                  echo "Environment=\"ADMIN_USERNAME=$ADMIN_USERNAME\"" | sudo tee -a /etc/systemd/system/cfb-rankings.service
                  echo "Environment=\"ADMIN_PASSWORD=$ADMIN_PASSWORD\"" | sudo tee -a /etc/systemd/system/cfb-rankings.service
                  sudo systemctl daemon-reload
              fi
              
              # Restart service
              sudo systemctl restart cfb-rankings
              sleep 3
              
              # Check if service is running
              if sudo systemctl is-active cfb-rankings >/dev/null; then
                  echo "🎉 Deployment successful!"
                  rm /home/ubuntu/app.py.backup
              else
                  echo "❌ Service failed, rolling back"
                  cp /home/ubuntu/app.py.backup /home/ubuntu/cfb-app/app.py
                  sudo systemctl restart cfb-rankings
                  echo "✅ Rollback complete"
              fi
          else
              echo "❌ New code failed validation - no deployment"
          fi
